name: Deploy

on:
  pull_request:
    branches:
      - develop
      - main
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        run: |
          sh ./build.sh

      # ì–´ë–¤ ë¸Œëœì¹˜ë¡œ ë³´ë‚¼ì§€ ê²°ì •
      - name: Decide deploy target
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "target_branch=preview" >> $GITHUB_OUTPUT
          else
            echo "target_branch=main" >> $GITHUB_OUTPUT
          fi

      # ê°œì¸ Deploy ë ˆí¬ë¡œ push (ìš°íšŒë°°í¬)
      - name: Push to deploy repository
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.AUTO_ACTIONS }}
        with:
          source-directory: 'output'
          destination-github-username: unanbb
          destination-repository-name: PHOTOWHALE-Deploy
          user-email: ${{ secrets.EMAIL }}
          commit-message: >
            ${{ github.event.pull_request.title || github.event.head_commit.message }}
          target-branch: ${{ steps.vars.outputs.target_branch }}

      # PRì¼ ë•Œë§Œ Preview ë§í¬ ì½”ë©˜íŠ¸
      - name: Comment Preview URL
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ğŸš€ Preview ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

            ğŸ‘‰ Vercel Previewì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
